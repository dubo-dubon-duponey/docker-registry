{$CDY_SCHEME}://{$CDY_DOMAIN} {$CDY_ADDITIONAL_DOMAINS} {
  import /config/caddy/conf.d/log.conf "{$CDY_LOG_LEVEL}"
  import /config/caddy/conf.d/headers.conf "{$CDY_SERVER_NAME}"
  import /config/caddy/conf.d/proxyauth.conf
  import /config/caddy/conf.d/tls*{$CDY_TLS_DISABLE}.conf "{$CDY_TLS_MODE}" "{$CDY_TLS_MIN}"
  import /config/caddy/conf.d/mtls*{$CDY_MTLS_DISABLE}.conf "{$CDY_TLS_MODE}" "{$CDY_MTLS_MODE}" "{$CDY_MTLS_TRUST}"

  @pull_disabled {
    expression '{$PULL}' == 'disabled'
    method HEAD GET
    path /v2/*
  }

  @pull_anonymous {
    expression '{$PULL}' == 'anonymous'
    method HEAD GET
    path /v2/*
  }

  @pull_authenticated {
    expression '{$PULL}' == 'authenticated'
    method HEAD GET
    path /v2/*
  }

  @push_disabled {
    expression '{$PUSH}' == 'disabled'
    method POST PUT PATCH DELETE
    path /v2/*
  }

  @push_authenticated {
    expression '{$PUSH}' == 'authenticated'
    method POST PUT PATCH DELETE
    path /v2/*
  }

  # Remove dupe entry (this is set by the backend)
  header -Docker-Distribution-API-Version
  header Docker-Distribution-API-Version "registry/2.0"

  handle @pull_disabled {
    respond 403 {
      body "{\"details\": \"Pull is disabled on this server\"}"
      close
    }
  }

  handle @push_disabled {
    respond 403 {
      body "{\"details\": \"Push is disabled on this server\"}"
      close
    }
  }

  handle @pull_authenticated {
    import /config/caddy/conf.d/auth.conf "{$CDY_AUTH_REALM}" "{$CDY_AUTH_USERNAME}" "{$CDY_AUTH_PASSWORD}"
  }

  handle @push_authenticated {
    import /config/caddy/conf.d/auth.conf "{$CDY_AUTH_REALM}" "{$CDY_AUTH_USERNAME}" "{$CDY_AUTH_PASSWORD}"
  }

  reverse_proxy http://127.0.0.1:10042 {
    header_up X-Forwarded-Port {$CDY_PORT_HTTPS}
    header_up X-Real-IP {remote_ip}
  }
}
